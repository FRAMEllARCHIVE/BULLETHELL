<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dungeons</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="module" src="controls.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: grey;
            user-select: none;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="joystick">
        <div id="joystick-indicator"></div>
    </div>

    <script>
        import { Controls } from './controls.js';

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            width: 100,
            height: 100,
            frameX: 0,
            frameY: 0,
            speed: 5,
            moving: false
        };

        const map = new Image();
        map.src = 'map.png';

        const mapOffset = {
            x: 0,
            y: 0
        };

        const controls = new Controls();
        controls.initKeyboard();
        controls.initGamepad();
        controls.initJoystick();

        const spritesheet = new Image();
        spritesheet.src = 'spritesheet.png';

        function drawPlayer() {
            ctx.drawImage(
                spritesheet,
                player.frameX * player.width,
                player.frameY * player.height,
                player.width,
                player.height,
                player.x - player.width / 2,
                player.y - player.height / 2,
                player.width,
                player.height
            );
        }

        function drawMap() {
            ctx.drawImage(map, mapOffset.x, mapOffset.y, map.width, map.height);
        }

        function handlePlayerMovement() {
            let moved = false;

            if (controls.keys.w || (controls.gamepad && controls.gamepad.axes[1] < -0.5)) {
                mapOffset.y += player.speed;
                moved = true;
            }
            if (controls.keys.s || (controls.gamepad && controls.gamepad.axes[1] > 0.5)) {
                mapOffset.y -= player.speed;
                moved = true;
            }
            if (controls.keys.a || (controls.gamepad && controls.gamepad.axes[0] < -0.5)) {
                mapOffset.x += player.speed;
                moved = true;
            }
            if (controls.keys.d || (controls.gamepad && controls.gamepad.axes[0] > 0.5)) {
                mapOffset.x -= player.speed;
                moved = true;
            }

            if (moved) {
                player.moving = true;
                player.frameX = (player.frameX + 1) % 4; // Cycle through animation frames
            } else {
                player.moving = false;
                player.frameX = 0;
            }
        }

        function updateGamepad() {
            controls.updateGamepad();
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawMap();
            drawPlayer();
            handlePlayerMovement();
            updateGamepad();
            requestAnimationFrame(gameLoop);
        }

        spritesheet.onload = () => {
            map.onload = () => {
                gameLoop();
            };
        };
    </script>
</body>
</html>
